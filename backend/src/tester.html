<!doctype html>
<html>
  <body>
    <div>
      <input id="match" value="demo1" />
      <input id="name" value="Player-" />
      <select id="category">
        <option value="">Any Category</option>
      </select>
      <select id="difficulty">
        <option value="">Any Difficulty</option>
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
      <button id="join">Join</button>
      <button id="ready">Ready</button>
      <button id="unready">Unready</button>
      <button id="start">Start</button>
      <button id="cancel">Cancel</button>
    </div>

    <div id="players"></div>
    <div id="cfg"></div>
    <div id="q"></div>
    <div id="choices"></div>

    <div>
      Time: <span id="t">-</span> <span id="ack"></span>
    </div>

    <div id="scores"></div>

    <script src="http://localhost:4000/socket.io/socket.io.js"></script>
    <script>
      var $ = function (id) {
        return document.getElementById(id);
      };
      var s = io("http://localhost:4000", { transports: ["websocket"] }),
        m = null,
        q = null,
        isHost = false,
        started = false;

      // populate categories from backend
      fetch("http://localhost:4000/categories")
        .then(function (r) { return r.json(); })
        .then(function (d) {
          var cats = (d && d.categories) || [];
          var sel = $("category");
          cats.forEach(function (c) {
            var opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            sel.appendChild(opt);
          });
        })
        .catch(function () { /* ignore */ });

      function renderPlayers(arr) {
        var r = $("players");
        r.innerHTML = "";
        (arr || []).forEach(function (p) {
          var span = document.createElement("span");
          span.textContent =
            p.displayName + (p.points ? " (" + p.points + ")" : "");
          if (p.ready) {
            span.style.background = "#d4f8d4";
          }
          span.style.margin = "2px";
          span.style.padding = "3px 6px";
          span.style.borderRadius = "6px";
          r.appendChild(span);
        });
      }

      function renderScores(b) {
        var r = $("scores");
        r.innerHTML = "";
        (b || []).forEach(function (e, i) {
          var d = document.createElement("div");
          var avg = e.averageResponseMs != null ? Math.round(e.averageResponseMs) + " ms" : "n/a";

          var correct = typeof e.correct === "number" ? e.correct : 0;

          d.textContent = i + 1 + ". " + e.displayName + " - " + e.points + " pts (correct: " + correct + ", avg: " + avg + ")";
          r.appendChild(d);
        });
      }

      function setTimer(ms) {
        $("t").textContent = Math.ceil(ms / 1000) + "s";
      }

      function renderQuestion(x) {
        q = x;
        $("q").textContent = "Round " + x.round + " Q" + x.index + ": " + x.text;
        var r = $("choices");
        r.innerHTML = "";
        x.choices.forEach(function (c, i) {
          var b = document.createElement("button");
          b.textContent = String.fromCharCode(65 + i) + ". " + c;
          b.onclick = function () {
            submit(c);
          };
          r.appendChild(b);
        });
      }

      function disableChoices() {
        Array.prototype.forEach.call(
          $("choices").querySelectorAll("button"),
          function (b) {
            b.disabled = true;
          }
        );
      }

      function submit(ans) {
        if (!q || !m) return;
        disableChoices();
        s.emit("answer:submit", {
          matchId: m,
          questionId: q.questionId,
          answer: ans,
          atMs: Date.now(),
        });
      }

      $("join").onclick = function () {
        m = $("match").value.trim() || "demo1";
        var n =
          ($("name").value.trim() || "Player") + Math.floor(Math.random() * 1000);
        s.emit("match:join", { matchId: m, displayName: n });
      };

      $("ready").onclick = function () {
        if (!m) return;
        s.emit("lobby:ready", { matchId: m, ready: true });
      };

      $("unready").onclick = function () {
        if (!m) return;
        s.emit("lobby:ready", { matchId: m, ready: false });
      };

      function updateControls() {
        // Only host can choose category/difficulty and start
        $("category").disabled = !isHost;
        $("difficulty").disabled = !isHost;
        $("start").disabled = !isHost || !m;
        $("cancel").disabled = !isHost || !m;
        $("ready").disabled = started;
        $("unready").disabled = started;
      }

      $("start").onclick = function () {
        if (!m) return;
        var cat = $("category").value;
        var dif = $("difficulty").value;
        var payload = { matchId: m, rounds: 1, perRound: 3 };
        if (cat) payload.category = cat;
        if (dif) payload.difficulty = dif;
        s.emit("host:start", payload);
      };

      $("cancel").onclick = function () {
        if (!m) return;
        s.emit("host:cancel", { matchId: m });
      };

      s.on("presence:update", function (d) {
        renderPlayers(d.players);
        // Determine if this client is host via hostId
        if (d && d.hostId) {
          isHost = d.hostId === s.id;
          updateControls();
        }
      });
      s.on("host:start:ack", function (ack) {
        if (!ack || !ack.accepted) {
          alert("Start rejected: insufficient questions for selected filters");
        }
      });
      s.on("lobby:config", function (cfg) {
        started = true;
        var text = "Setup â€” ";
        if (cfg.category) text += "Category: " + cfg.category + "; ";
        if (cfg.difficulty) text += "Difficulty: " + cfg.difficulty + "; ";
        text += "Rounds: " + (cfg.rounds || 1) + " x " + (cfg.perRound || 3) + "; ";
        text += "Time/Q: " + Math.round((cfg.perQuestionMs || 0) / 1000) + "s";
        $("cfg").textContent = text;
        updateControls();
      });
      s.on("question:show", function (x) {
        renderQuestion(x);
        setTimer(x.timeLimitMs);
      });
      s.on("timer:tick", function (t) {
        setTimer(t.msRemaining);
      });
      s.on("answer:ack", function (a) {
        $("ack").textContent = a.accepted ? "Accepted" : "Rejected";
      });
      s.on("question:reveal", function (r) {
        $("ack").textContent = "Correct: " + r.correctAnswer;
        disableChoices();
      });
      s.on("score:update", function (sco) {
        renderScores(sco.leaderboard);
      });
      s.on("match:end", function (me) {
        renderScores(me.ranking);
        disableChoices();
        $("t").textContent = "-";
        started = false;
        updateControls();
      });
    </script>
  </body>
</html>
